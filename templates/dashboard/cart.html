{% extends 'partials/base.html' %}
{% load static %}
{% block content %}
  <div class="row">
    <div class="col-lg-12">
      <div class="box-element">
        <a class="btn btn-outline-dark" href="{% url 'test' %}">&#x2190; Continue Shopping</a>
        <br />
        <br />
        <table class="table">
          <tr>
            <th>Product</th>
            <th>Item name</th>
            <th>Desc</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Total</th>
            <th>Action</th>
          </tr>
          {% for product_id, item in cart_items.items %}
          <tr id="cart-item-{{ product_id }}">
            <td>
              <img src="{{ item.image }}" alt="{{ item.name }}" style="height: 220px; width: 192px;" />
            </td>
            <td>{{ item.name }}</td>
            <td>{{ item.description }}</td>
            <td>₹{{ item.price }}</td>
            <td>
              <button class="btn btn-outline-secondary update-cart" data-product="{{ product_id }}" data-action="decrease" data-stock="{{ item.available_stock }}">-</button>
              <span id="quantity-{{ product_id }}">{{ item.quantity }}</span>
              <button class="btn btn-outline-secondary update-cart" data-product="{{ product_id }}" data-action="increase" data-stock="{{ item.available_stock }}">+</button>
            </td>
            <td id="total-{{ product_id }}" data-price="{{ item.price }}">{{ item.price|floatformat:2 }}</td>
            <td>
              <button class="btn btn-danger delete-from-cart" data-product="{{ product_id }}">Delete</button>
            </td>
          </tr>
        {% endfor %}
        
        </table>
        <h3>Total: ₹<span id="total-price">{{ total_price|floatformat:2 }}</span></h3>
        <a href="{% url 'checkout' %}" class="btn btn-success">Checkout</a>
      </div>
    </div>
  </div>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.update-cart').forEach((button) => {
          button.addEventListener('click', function () {
            const productId = this.getAttribute('data-product');
            const action = this.getAttribute('data-action');
            const quantityElement = document.querySelector(`#quantity-${productId}`);
            const currentQuantity = parseInt(quantityElement.textContent);
            
            // Get the available stock from the data-stock attribute
            const availableStock = parseInt(this.getAttribute('data-stock'));
      
            // Prevent increase if quantity exceeds available stock
            if (action === "increase" && currentQuantity >= availableStock) {
              alert("Cannot increase quantity above available stock.");
              return;
            }
      
            fetch(`/update_cart/${productId}/${action}/`, {
              method: 'GET'
            })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                quantityElement.textContent = data.new_quantity;
      
                const totalElement = document.querySelector(`#total-${productId}`);
                const productPrice = parseFloat(totalElement.dataset.price);
                totalElement.textContent = `${(productPrice * data.new_quantity).toFixed(2)}`;
      
                document.getElementById('total-price').textContent = `${data.new_total_price.toFixed(2)}`;
              } else {
                alert(data.error || 'Error updating cart');
              }
            })
            .catch((error) => {
              console.error('Error updating cart:', error);
            });
          });
        });
      
        // Add delete functionality
        document.querySelectorAll('.delete-from-cart').forEach((button) => {
          button.addEventListener('click', function () {
            const productId = this.getAttribute('data-product');
            fetch(`/delete_cart_item/${productId}/`, {
              method: 'GET'
            })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                // Remove the product row from the table
                location.reload();
                const row = document.getElementById(`cart-item-${productId}`);
                if (row) {
                  row.remove();
                  
                }
                // Update the total price
                document.getElementById('total-price').textContent = `${data.new_total_price.toFixed(2)}`;
              }
            })
            .catch((error) => {
              console.error('Error deleting cart item:', error);
            });
          });
        });
      });    
    </script>

{% endblock %}
